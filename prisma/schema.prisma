// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

// Users 
enum UserRole {
  ADMIN
  PROVIDER_ADMIN
  BRANCH_ADMIN
  CASHIER
}

// Users 
enum ActiveStatus {
  ACTIVE
  IN_ACTIVE
}

model User {
  id       String @id @default(cuid())
  fullName String

  email       String? @unique
  userName    String? @unique
  phoneNumber String  @unique
  password    String

  role            UserRole
  status          ActiveStatus     @default(ACTIVE)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  refreshTokens   RefreshToken[]
  providers       Provider[] 
}

model Cashier {
  id             String          @id @unique @default(uuid())
   fullName String 
  userName    String? @unique
  phoneNumber String  
  password    String

    status          ActiveStatus     @default(ACTIVE)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  branchId       String  
  branch         Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  tickets        Ticket[] 
  cancelledTickets        Ticket[] @relation(name: "cancelledTickets")
  ticketPayments TicketPayment[]
  refreshTokens   RefreshToken[]

}

model RefreshToken {
  id          String   @id @unique @default(uuid())
  hashedToken String
  userId      String?
  User        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

   cashierId      String?
  Cashier        Cashier?     @relation(fields: [cashierId], references: [id], onDelete: Cascade)

  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
 

// providers
model Provider {
  id         String @id @default(cuid())
  name       String
  identifier String @unique
  address    String

  status    ActiveStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  admins    User[]
  branches  Branch[]
}

// branch
model Branch {
  id         String @id @default(cuid())
  identifier String @unique
  name       String
  address    String
  providerId String

  status    ActiveStatus     @default(ACTIVE)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  provider  Provider         @relation(fields: [providerId], references: [id], onDelete: Cascade)
  cashiers  Cashier[]
  games     Game[]
}

// Keno Game
enum GameStatus {
  NOT_STARTED
  ON_PLAY
  DONE
}

// Keno Game
enum GameType {
  KENO
  DOG_RACING
  HORSE_RASING
}

enum TicketStatus {
  ON_PLAY
  WIN
  LOSE
  PAID
  CANCELLED
}

enum TicketSelectionStatus {
  ON_PLAY
  WIN
  LOSE
  PAID
}

// Base Game model
model Game {
  id       String     @id @default(cuid())
  uniqueId String
  branchId String
  gameType GameType
  startAt  DateTime
  endAt    DateTime
  status   GameStatus @default(NOT_STARTED)


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  tickets   Ticket[]
  keno      KenoGame?
  dogRacing DogRacingGame? // Add other game relations here
}

model Ticket {
  id                String       @id @default(cuid())
  uniqueId          String
  totalBetAmount    Float?
  possibleWinAmount Float?
  winAmount         Float?       @default(0.0)
  status            TicketStatus @default(ON_PLAY)
  createdAt         DateTime     @default(now())

  gameId            String
  game            Game             @relation(fields: [gameId], references: [id])

  cashierId         String
  cashier         Cashier   @relation(fields: [cashierId], references: [id]) 


  cancelledAt         DateTime? 
  cancelledCashierId         String?
  cancelledBy         Cashier?   @relation(name: "cancelledTickets", fields: [cancelledCashierId], references: [id]) 


  kenoTicket      KenoTicket?
  dogRacingTicket DogRacingTicket? // Add other game ticket relations here
  payment         TicketPayment?
}

model KenoGame {
  id                             String   @id @default(cuid())
  gameId                         String   @unique
  winningNumbers                 Int[]
  ticketWillBeDisabledAt         DateTime
  winningNumberWillBeShowedAt DateTime 

  game Game @relation(fields: [gameId], references: [id])
}

model DogRacingGame {
  id                             String   @id @default(cuid())
  gameId                         String   @unique 
  ticketWillBeDisabledAt         DateTime  

  game Game @relation(fields: [gameId], references: [id])
}

model KenoTicket {
  id         String            @id @default(cuid())
  ticketId   String            @unique
  selections TicketSelection[]

  ticket Ticket @relation(fields: [ticketId], references: [id])
}

model DogRacingTicket {
  id       String @id @default(cuid())
  ticketId String @unique
  // Add specific fields for AnotherGameTicket

  ticket Ticket @relation(fields: [ticketId], references: [id])
}

model TicketSelection {
  id                String                @id @default(cuid())
  ticketId          String
  selectedNumbers   Int[]
  betAmount         Float
  possibleWinAmount Float?
  winAmount         Float? 
  status            TicketStatus @default(ON_PLAY)

  ticket            KenoTicket            @relation(fields: [ticketId], references: [id])
}

model TicketPayment {
  id          String       @id @default(cuid())
  ticketId    String       @unique
  cashierId   String
  paidAmount Float?       @default(0.0) 
  createdAt   DateTime     @default(now())

  ticket  Ticket         @relation(fields: [ticketId], references: [id])
  cashier Cashier @relation(fields: [cashierId], references: [id])
}
